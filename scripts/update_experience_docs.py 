import os
import json
from datetime import datetime

EXPERIENCE_FOLDER = "experience_jsons"
OUTPUT_FILE = "experience_master.json"

# 读取已有 master 文件（如果存在）
if os.path.exists(OUTPUT_FILE):
    with open(OUTPUT_FILE, "r", encoding="utf-8") as f:
        master_data = json.load(f)
else:
    master_data = []

# 用一个 dict 根据 key 来判断是否重复/需要替换
# 这里假设每条经验 JSON 都有 'id' 或 'title' 字段可以唯一标识经验
existing_index = {}
for entry in master_data:
    key = entry.get("id") or entry.get("title") or json.dumps(entry, sort_keys=True)
    existing_index[key] = entry

# 遍历 experience_jsons 文件夹
json_files = sorted(f for f in os.listdir(EXPERIENCE_FOLDER) if f.endswith(".json"))

for fname in json_files:
    path = os.path.join(EXPERIENCE_FOLDER, fname)
    try:
        with open(path, "r", encoding="utf-8") as f:
            data = json.load(f)

        if isinstance(data, list):
            items = data
        else:
            items = [data]

        for item in items:
            # 每条经验元信息
            key = item.get("id") or item.get("title") or json.dumps(item, sort_keys=True)
            meta = {
                "source_file": fname,
                "merged_at": datetime.utcnow().isoformat() + "Z",
                "superseded": False,
                "branch_name": f"exp-{datetime.utcnow().strftime('%Y%m%d%H%M%S')}-{fname.replace('.json','')}"
            }

            # 如果 master 已有该经验，则标记旧经验为 superseded
            if key in existing_index:
                old_entry = existing_index[key]
                old_entry["superseded"] = True
                print(f"Superseding old entry from {old_entry['source_file']}")

            # 添加新经验
            if isinstance(item, dict):
                item.update(meta)
            else:
                item = {"content": item, **meta}

            existing_index[key] = item

    except Exception as e:
        print(f"Failed to process {fname}: {e}")

# 输出合并结果
merged_experiences = list(existing_index.values())
with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
    json.dump(merged_experiences, f, indent=2, ensure_ascii=False)

print(f"Merged {len(merged_experiences)} experience entries into {OUTPUT_FILE}")
# 注意：这个脚本假设 experience_jsons 文件夹中的每个 JSON 文件都包含一个或多个经验条目。