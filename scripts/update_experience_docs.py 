import os
from github import Github
from datetime import datetime
from pathlib import Path

# =============================
# 配置区
# =============================
# 仓库名称，例如 "username/repo"
REPO_NAME = "username/repo"

# 本地经验文档路径（相对于仓库根目录）
EXPERIENCE_DIR = "experience-docs"

# GitHub Token (在 GitHub Actions 中可以使用 GITHUB_TOKEN)
GITHUB_TOKEN = os.environ.get("GITHUB_TOKEN") or os.environ.get("EXPERIENCE_GH_TOKEN")

if not GITHUB_TOKEN:
    raise ValueError("GitHub token not found. Set GITHUB_TOKEN or EXPERIENCE_GH_TOKEN in environment variables.")

# =============================
# 初始化 GitHub API
# =============================
g = Github(GITHUB_TOKEN)
repo = g.get_repo(REPO_NAME)
main_branch = repo.get_branch("main")

# =============================
# 创建带时间戳的分支
# =============================
timestamp = datetime.utcnow().strftime("%Y%m%d-%H%M%S")
branch_name = f"experience-update-{timestamp}"

# 检查分支是否已存在
if branch_name not in [b.name for b in repo.get_branches()]:
    repo.create_git_ref(ref=f"refs/heads/{branch_name}", sha=main_branch.commit.sha)
    print(f"Created branch: {branch_name}")
else:
    print(f"Branch {branch_name} already exists, using existing.")

# =============================
# 扫描本地经验文档
# =============================
experience_path = Path(EXPERIENCE_DIR)
if not experience_path.exists():
    raise FileNotFoundError(f"{EXPERIENCE_DIR} does not exist.")

experience_files = list(experience_path.glob("*.json"))
if not experience_files:
    print("No experience JSON files found. Nothing to update.")
    exit(0)

# =============================
# 上传或更新文件到分支
# =============================
for file_path in experience_files:
    file_name = file_path.name
    repo_path = f"{EXPERIENCE_DIR}/{file_name}"

    with open(file_path, "r", encoding="utf-8") as f:
        content = f.read()

    try:
        # 检查文件是否已存在
        contents = repo.get_contents(repo_path, ref=branch_name)
        repo.update_file(
            path=repo_path,
            message=f"[AI] Update experience doc {file_name}",
            content=content,
            sha=contents.sha,
            branch=branch_name
        )
        print(f"Updated {file_name} in branch {branch_name}")
    except:
        # 文件不存在则创建
        repo.create_file(
            path=repo_path,
            message=f"[AI] Add experience doc {file_name}",
            content=content,
            branch=branch_name
        )
        print(f"Created {file_name} in branch {branch_name}")

# =============================
# 自动生成 Pull Request
# =============================
pr_title = f"[AI] Update experience docs {timestamp}"
pr_body = "Auto-generated PR for experience document updates by AI."

existing_prs = list(repo.get_pulls(state="open", head=branch_name))
if existing_prs:
    print(f"PR already exists: {existing_prs[0].html_url}")
else:
    pr = repo.create_pull(
        title=pr_title,
        body=pr_body,
        head=branch_name,
        base="main"
    )
    print(f"Created PR: {pr.html_url}")

print("✅ Experience document update process completed.")
